#!/usr/bin/env node
/**
 * Generate bundled_libraries.js
 * 
 * Scans src/core/scheme/ and src/extras/scheme/ for .sld and .scm files,
 * then generates src/packaging/bundled_libraries.js with embedded sources.
 * 
 * Run: node scripts/generate_bundled_libraries.js
 * Or: npm run prebuild (automatically runs before npm run build)
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = path.join(__dirname, '..');

const dirs = [
    path.join(projectRoot, 'src/core/scheme'),
    path.join(projectRoot, 'src/extras/scheme')
];

const sources = {};

for (const dir of dirs) {
    if (!fs.existsSync(dir)) continue;

    for (const file of fs.readdirSync(dir)) {
        if (file.endsWith('.sld') || file.endsWith('.scm')) {
            const content = fs.readFileSync(path.join(dir, file), 'utf8');
            sources[file] = content;
        }
    }
}

const output = `// Auto-generated by scripts/generate_bundled_libraries.js - do not edit manually
// Contains all .sld and .scm files from src/core/scheme/ and src/extras/scheme/

export const BUNDLED_SOURCES = ${JSON.stringify(sources, null, 2)};
`;

const outputPath = path.join(projectRoot, 'src/packaging/bundled_libraries.js');
fs.writeFileSync(outputPath, output);

console.log(`Generated ${outputPath} with ${Object.keys(sources).length} embedded files.`);
